# coding=utf-8
# Always believe,always hope.

#æ„Ÿè°¢æ‚¨çš„é‡è§ï¼
#æœ¬é¡¹ç›®ï¼ˆPyMinecraftï¼‰GitHubåœ°å€ï¼š
#https://github.com/chinese-wzq/PyMinecraft
#æœ¬é¡¹ç›®ï¼ˆPyMinecraftï¼‰Giteeåœ°å€ï¼š
#https://gitee.com/this_is_the_best_name/PyMinecraft
#å¦‚æœä½ å‘ç°æœ‰æ— è‰¯ç¨‹åºå‘˜å¤§é‡ç›—ç”¨æœ¬ç¨‹åºä»£ç å¹¶ä¸”æœªåŠ å£°æ˜çš„
#æ¬¢è¿ä½ ä¸ä»–å¯¹çº¿ï¼Œå¹¶ä¸”å°†ä»–çš„ä½œå“åœ°å€å‘ç»™æˆ‘ï¼ˆè®©æˆ‘åº·åº·å•Šâ™‚ï¼‰
#ä»¥ä¸‹ä¸ºç¨‹åºå£°æ˜ä»¥åŠä¸€äº›ä»‹ç»ï¼Œå¦‚æœæœ‰ä¸ç¬¦åˆè§„èŒƒçš„æ¬¢è¿æå‡ºæ‹‰å–è¯·æ±‚ï¼Œæˆ‘ä¸æ‡‚å¼€æºåè®®ï¼Œå¤ªå¤šäº†QAQ

#æœ¬ç¨‹åºä½¿ç”¨å­—ä½“ï¼šJetBrains Monoï¼Œå­—ä½“ä¸åŒå¯èƒ½ä¼šå‡ºç°ç¨‹åºå†…çš„æ³¨é‡Šæ’ç‰ˆç´Šä¹±ï¼

#æœ¬ç¨‹åºéƒ¨åˆ†è¡Œè¾ƒé•¿ã€‚ä¸ºä»€ä¹ˆï¼Ÿå› ä¸ºè§‰å¾—è¿™æ ·å¾ˆçˆ½ï¼ˆè«åï¼‰

################################################
#                æœ¬ä½œå“ä¸ºå…´è¶£ä½¿ç„¶                 #
#             æˆ‘å¹¶æ²¡æœ‰æ”¶è¿‡ä»»ä½•äººçš„é’±è´¢              #
#             ä¹Ÿæ²¡æœ‰ä¸ä»»ä½•äººæœ‰å¥‘çº¦å…³ç³»              #
#     æœ¬ä½œå“ä¸MOJANGå·¥ä½œå®¤ï¼ˆBUGJUMPï¼‰æ²¡æœ‰ä»»ä½•å…³ç³»    #
#     æˆ‘ä»æ¥æ²¡æœ‰æŸ¥çœ‹è¿‡Minecraftçš„æºç ï¼ˆåæ­£çœ‹ä¸æ‡‚ï¼‰   #
#      æœ¬ä½œå“ä»…ä¾›å­¦ä¹ ã€å¨±ä¹ï¼Œå•†ç”¨è¯·æ³¨æ˜é¡¹ç›®åœ°å€        #
#        æ¬¢è¿æäº¤æ‹‰å–è¯·æ±‚ï¼Œè¿™æ˜¯å¯¹æˆ‘æœ€å¤§çš„æ”¯æŒ         #
#    æˆ‘ä¹Ÿåªæ˜¯ä¸€ä¸ªå°å°çš„åˆäºŒç”Ÿï¼Œå¾ˆå¤šæ•°å­¦è®¡ç®—ç•¥ä¸ºç²—ç³™     #
#            å› æ­¤å¸Œæœ›æ‚¨å¸®åŠ©æ”¹è¿›æˆ‘çš„ç®—æ³•             #
################################################
#            æœ¬æ¸¸æˆæ˜¯å¼€æºçš„ï¼Œæ‰€æœ‰äººå¯ç¼–è¾‘           #
#           å› æ­¤ï¼Œæˆ‘æ‰èƒ½å°½é‡ä¿è¯ä»£ç çš„å®‰å…¨æ€§         #
#          æœ¬æ¸¸æˆä»è®¾è®¡ä¹‹åˆå°±é‡‡ç”¨äº†è¶…å¤šå‡½æ•°è®¾ç½®       #
#          è¿™ä½¿å¾—æ¸¸æˆçš„å¤§éƒ¨åˆ†å‡½æ•°å…·æœ‰å‚è€ƒä»·å€¼        #
#             å¦‚æœæœ¬æ¸¸æˆçš„æŸäº›å‡½æ•°å¸®åˆ°äº†æ‚¨          #
#        æ¬¢è¿æ‚¨åœ¨é¡¹ç›®åœ°å€ä¸Šç‚¹ä¸€ä¸ªå…è´¹çš„Starï¼ˆæ˜Ÿï¼‰     #
#             ä½ çš„æ˜Ÿä¼šæˆä¸ºæˆ‘Codingçš„åŠ¨åŠ›           #
################################################

#################æ„Ÿè°¢ä¸ä½ ç›¸é‡ï¼###################

#å¯¼å…¥OpenGLç›¸å…³åº“
import numpy
from OpenGL.GL import *
from OpenGL.GLUT import *
from OpenGL.GLU import *
#å¯¼å…¥å­—ä½“æ˜¾ç¤ºç›¸å…³åº“
from OpenGL.WGL import *
import win32ui
#å¯¼å…¥ä¸‰è§’å‡½æ•°ç›¸å…³åº“
import math
#å¯¼å…¥çª—å£ç›¸å…³åº“
import win32con,win32gui
#å¯¼å…¥åŒºå—è¯»å–ç›¸å…³åº“
import json,os,copy

#å…è®¸ç”¨æˆ·è‡ªå®šä¹‰çš„å˜é‡,å·²å°†å¤§éƒ¨åˆ†å˜é‡åšå¥½æ³¨é‡Š
mouse_move_speed=0.01 #é¼ æ ‡ç§»åŠ¨è·ç¦»
player_move_speed=0.1
look_length=15  #æ¸²æŸ“è·ç¦»,åªæ”¯æŒä¸å°äº1çš„å¥‡æ•°
highest_y=100  #ä¸–ç•Œæœ€é«˜Yåæ ‡
lowest_y=0   #ä¸–ç•Œæœ€ä½Yåæ ‡ï¼Œç›®å‰å¦‚æœæ›´æ”¹å°†ä¼šæŠ¥é”™ï¼
player_x=0    #è¿™å‡ ä¸ªä¸å¿…ç»†è¯´ï¼Œéƒ½æ‡‚éƒ½æ‡‚
player_y=-1
player_z=-1
font="Microsoft YaHei UI"    #æ˜¾ç¤ºæ–‡å­—æ—¶ä½¿ç”¨çš„å­—ä½“
window_long=400    #çª—å£çš„é•¿ä¸å®½
window_width=400
set_chat_list_show_time=50      #èŠå¤©æ¡†æ˜¾ç¤ºå¤šä¹…ï¼Œ2/3æ—¶é—´ä¸å˜ï¼Œ1/3æ—¶é—´æ·¡åŒ–æ¶ˆå¤±
saves_folder_dir="D:\\æ¡Œé¢\\PyMinecraft\\saves\\"   #æŒ‡å®šäº†å­˜å‚¨æ‰€æœ‰å­˜æ¡£çš„æ–‡ä»¶å¤¹çš„ä½ç½®
save_folder_dir="D:\\æ¡Œé¢\\PyMinecraft\\saves\\example\\"   #æŒ‡å®šäº†å­˜å‚¨å•ä¸ªå­˜æ¡£çš„æ–‡ä»¶å¤¹çš„ä½ç½®
load_all_save=False   #åœ¨å¯åŠ¨æ—¶å°±åŠ è½½æ‰€æœ‰çš„åŒºå—ï¼Œå¹¶ä¸”ä¸ä¼šæ‰§è¡Œå¸è½½å’ŒåŠ è½½çš„ç¨‹åºï¼Œå¯ä»¥å‡å°‘ç¨‹åºå¡é¡¿ï¼Œä½†åœ¨å­˜æ¡£è¿‡å¤§æ—¶éœ€è°¨æ…å¼€å¯

#ç”¨æˆ·ä¸åº”è¯¥åŠ¨çš„å˜é‡
save_folder_files_list=os.listdir(save_folder_dir)
player_see_x=0
player_see_y=0
lock_muose=False
debug=False
map=[]
block_color=[(255,255,0)]
debug_text=[['XYZ:',0.0,',',0.0,',',0.0],
            ['EYE:',0,',',0],]
block_size=11   #å¿…é¡»ä¸ºå•æ•°
buffer_block_size=15   #ä¹Ÿå¿…é¡»ä¸ºå•æ•°
temp1=block_size/2#åŒºå—åŠ è½½çš„ç¼“å­˜å˜é‡
temp2=(buffer_block_size-1)/2
temp7=(block_size-1)/-2
keyboard={}
for i in [b'\x1b',b'`',b'w',b's',b'a',b'd']:keyboard[i]=False
input_text=False
input_buffer=""
chat_list=[]
chat_list_show_time=0
guide_buttons=[]
def float2int(i):return int(str(i).split(".")[0])
def write_list(wait_write_list:list,write:str,point:list,fill=0,fill_callback=None):#ä»£ç å†ä¸é‡å†™å°±TMè¦çˆ†ç‚¸äº†
    really_point=wait_write_list
    for i in range(len(point)):
        while point[i]>len(really_point)-1:
            if fill_callback is None:really_point.append(copy.copy(fill))
            else:really_point.append(fill_callback(i,point))
        if i==len(point)-1:
            really_point[point[i]]=write
            return wait_write_list
        really_point=really_point[point[i]]
#å¦‚æœè®¾ç½®ä¸ºåŠ è½½å…¨éƒ¨åŒºå—ï¼Œåˆ™è¿›è¡Œä¸€äº›æ“ä½œ
if load_all_save:
    for i in save_folder_files_list:
        a,b=i.split(",")
        a=int(a)
        b=int(b)
        with open(save_folder_dir+str(a)+','+str(b)) as f: map=write_list(map,json.load(f),[a>=0,a+int(a<0),b>=0,b+int(b<0)],fill=[])
def read_block(x:int,y:int,z:int):#æ­¤æ¨¡å—åŒ…è£…äº†è¯»å–æ–¹å—çš„ä»£ç ,æœªæ¥å¯èƒ½ä¹Ÿä¼šæŠŠä¸–ç•Œç”Ÿæˆçš„ä»£ç æ”¾é‡Œè¾¹ï¼
    #ä»¥ä¸‹ä¸ºåŸºæœ¬åŸç†ï¼š
    #1.å…ˆè®¡ç®—è¾“å…¥åæ ‡ä½äºçš„åŒºå—ä½ç½®
    #2.è¯»å–åŒºå—æ–‡ä»¶ï¼Œå¹¶å°†åŒºå—æ”¾å…¥mapè¿›è¡Œç¼“å­˜
    #                               â†‘
    #å°†åŒºå—æ”¾å…¥ç¼“å­˜ä¸­ï¼Œå¹¶å¸è½½è¶…å‡ºç¼“å­˜åŒºåŸŸçš„åŒºå—ï¼Œå…³äºmapçš„åŒºå—ç´¢å¼•ç»“æ„ç»“æ„ï¼šï¼ˆå­˜åœ¨è´Ÿæ•°ï¼Œæ¯å±‚éœ€è¦ä¸¤å±‚ï¼Œä¸€å±‚æ­£ä¸€å±‚è´Ÿï¼‰
    #                                                         ç¬¬ä¸€å±‚ï¼šåŒºå—çš„X
    #                                                         ç¬¬äºŒå±‚ï¼šåŒºå—çš„Z
    #                                                         æ­¤ç´¢å¼•æ–¹æ³•è™½ç„¶ä¼šå‡ºç°è®¸å¤šç©ºçš„é¡¹ï¼Œä½†æ˜¯æ¯”å…¨éƒ¨è½½å…¥å¯¹å†…å­˜çš„æ¶ˆè€—å°‘å¾—å¤šäº†
    #3.ä»åŒºå—é‡Œè¯»å–æŒ‡å®šä½ç½®æ–¹å—,ç´¢å¼•æ–¹æ³•ï¼šï¼ˆä¸å­˜åœ¨è´Ÿæ•°æƒ…å†µï¼‰ï¼Œéšåè¿”å›æŒ‡å®šä½ç½®æ–¹å—
    #                              ç¬¬ä¸€å±‚ï¼šY
    #                              ç¬¬äºŒå±‚ï¼šX
    #                              ç¬¬äºŒå±‚ï¼šZ
    global map
    #ç¬¬ä¸€æ­¥
    i=1
    ii=1
    if x<0:i=-1
    if z<0:ii=-1
    block_X=float2int((x+temp1*i)/block_size)
    block_Z=float2int((z+temp1*ii)/block_size)
    #ç¬¬äºŒæ­¥ï¼Œè¿™é‡Œå†³å®šå…ˆå¸è½½å†è½½å…¥
    temp3=block_X>=0
    temp4=block_X+int(block_X<0)
    temp5=block_Z>=0
    temp6=block_Z+int(block_Z<0)
    if not load_all_save:
        for i in range(len(map)):
            for ii in range(len(map[i])):
                for iii in range(len(map[i][ii])):
                    for iiii in range(len(map[i][ii][iii])):
                        if i>0:a=ii
                        else:a=ii*-1-1
                        if iii>0:aa=iiii
                        else:aa=iiii*-1-1
                        if not block_X-temp2<=a<=block_X+temp2 or not block_Z-temp2<=aa<=block_Z+temp2:
                            with open(save_folder_dir+str(a)+","+str(aa),"w") as f:json.dump(map[i][ii][iii][iiii],f)
                            map[i][ii][iii][iiii]=0
        try:
            if not map[temp3][temp4][temp5][temp6]:raise IndexError
        except IndexError:
            if str(block_X)+','+str(block_Z) in save_folder_files_list:
                with open(save_folder_dir+str(block_X)+','+str(block_Z)) as a:map=write_list(map,json.load(a),[temp3,temp4,temp5,temp6],[])
            else:
                return 0
    #ç¬¬ä¸‰æ­¥
    #    v4----- v5
    #   /|      /|
    #  v0------v1|
    #  | |â†—    | |
    #  | v7----|-v6
    #  |/      |/
    #  v3------v2â†’
    #ç›®æ ‡å°±æ˜¯å…ˆæ±‚å‡ºåŒºå—ä¸­å¿ƒï¼Œéšåæ±‚å‡ºV3è¿™ä¸ªç‚¹çš„ä½ç½®ï¼Œæœ€åæ¢ç®—åæ ‡è¿›å…¥åŒºå—åæ ‡ç³»
    center_block_x=(block_X-0.5)*block_size
    center_block_z=(block_Z-0.5)*block_size
    try:return map[temp3][temp4][temp5][temp6][y][float2int(x-center_block_x)][float2int(z-center_block_z)]
    except IndexError:return 0
def write_block_fill_callback(a,b):
    if a==len(b)-1:return 0
    else:return []
def write_block(x:int,y:int,z:int,write:int):
    global map
    #ç¬¬ä¸€æ­¥
    i=1
    ii=1
    if x<0:i=-1
    if z<0:ii=-1
    block_X=float2int((x+temp1*i)/block_size)
    block_Z=float2int((z+temp1*ii)/block_size)
    temp3=block_X>=0
    temp4=block_X+int(block_X<0)
    temp5=block_Z>=0
    temp6=block_Z+int(block_Z<0)
    center_block_x=(block_X-0.5)*block_size
    center_block_z=(block_Z-0.5)*block_size
    map=write_list(map,write,[temp3,temp4,temp5,temp6,y,float2int(x-center_block_x),float2int(z-center_block_z)],fill_callback=write_block_fill_callback)

draw=False
block_VAO=0
block_EBO_buffer_len=0
def print_blocks(sx:int,sy:int,sz:int):#è¿™é‡Œå°†æ¥ä¼šé€‰æ‹©æ€§æ˜¾ç¤ºæ–¹å—ï¼Œä¸ä¼šå…¨éƒ¨æ˜¾ç¤ºä¸€éï¼Œå¤šä¼¤æ˜¾å¡QAQ
    #ç‰¹åˆ«é¸£è°¢ï¼šStack Overflowç”¨æˆ·Rabbid76
    #æ²¡æœ‰ä»–å›ç­”äº†æˆ‘ä¸¤ä¸ªé—®é¢˜ï¼Œæˆ‘è¿™ä¸€è¾ˆå­éƒ½åšä¸å‡ºæ¥
    #é—®é¢˜é“¾æ¥ï¼š
    #https://stackoverflow.com/questions/70476151/opengl-vbo-can-run-without-error-but-no-graphics
    #https://stackoverflow.com/questions/70610206/opengl-vbo-vao-ebo-can-run-without-error-but-no-graphics
    #è™½ç„¶ä»–åˆ«æ²¡æœ‰å«æˆ‘è´´ä¸Šè¿™ä¸ªæ³¨é‡Šï¼Œä¸è¿‡æˆ‘æƒ³ï¼Œåšäººè¦å­¦ä¼šæ„Ÿæ©ğŸ˜€
    global draw,block_VAO,block_EBO_buffer_len
    if not draw:
        block_point_buffer=[]
        block_color_buffer=[]
        block_EBO_buffer=[]
        color_EBO_buffer=[]
        for x in range(sx-int((look_length-1)/2),sx+int((look_length-1)/2)+1):
            for y in range(lowest_y,highest_y+1):
                for z in range(sz-int((look_length-1)/2),sz+int((look_length-1)/2)+1):
                    by_wzq=read_block(x,y,z)
                    if not by_wzq==0:
                        #å›¾ç›—çš„
                        #    v4----- v5
                        #   /|      /|
                        #  v0------v1|
                        #  | |     | |
                        #  | v7----|-v6
                        #  |/      |/
                        #  v3------v2
                        a=len(block_point_buffer)/3
                        block_point_buffer+=[x-0.5,y+0.5,z-0.5,#V0
                                            x+0.5,y+0.5,z-0.5,#V1
                                            x+0.5,y-0.5,z-0.5,#V2
                                            x-0.5,y-0.5,z-0.5,#V3
                                            x-0.5,y+0.5,z+0.5,#V4
                                            x+0.5,y+0.5,z+0.5,#V5
                                            x+0.5,y-0.5,z+0.5,#V6
                                            x-0.5,y-0.5,z+0.5]#V7
                        block_EBO_buffer+=[a+0,a+1,a+5,a+4,
                                           a+3,a+2,a+6,a+7,
                                           a+0,a+3,a+7,a+4,
                                           a+1,a+2,a+6,a+5,
                                           a+0,a+1,a+2,a+3,
                                           a+4,a+5,a+6,a+7]
                        block_color_buffer+=block_color[by_wzq-1]*8
        #åˆ›å»ºé¡¶ç‚¹VBO
        block_VBO=glGenBuffers(1)
        glBindBuffer(GL_ARRAY_BUFFER,block_VBO)
        a=numpy.array(block_point_buffer,dtype='float32')
        glBufferData(GL_ARRAY_BUFFER,sys.getsizeof(a),a,GL_STATIC_DRAW)
        #åˆ›å»ºé¢œè‰²VBO
        color_VBO=glGenBuffers(1)
        glBindBuffer(GL_ARRAY_BUFFER,color_VBO)
        a=numpy.array(block_color_buffer,dtype='float32')
        glBufferData(GL_ARRAY_BUFFER,sys.getsizeof(a),a,GL_STATIC_DRAW)
        #ç»‘å®šVAO
        block_VAO=glGenVertexArrays(1)
        glBindVertexArray(block_VAO)
        #ç»‘å®šEBO
        #å¿…é¡»å…ˆç»‘å®šå†åˆ›å»ºEBO
        block_EBO=glGenBuffers(1)
        glBindBuffer(GL_ELEMENT_ARRAY_BUFFER,block_EBO)
        a=numpy.array(block_EBO_buffer,dtype='uint32')
        glBufferData(GL_ELEMENT_ARRAY_BUFFER,sys.getsizeof(a),a,GL_STATIC_DRAW)
        block_EBO_buffer_len=len(a)
        #ç»‘å®šé¡¶ç‚¹VBO
        glBindBuffer(GL_ARRAY_BUFFER,block_VBO)
        glVertexPointer(3,GL_FLOAT,0,None)
        glEnableClientState(GL_VERTEX_ARRAY)
        #ç»‘å®šé¢œè‰²VBO
        glBindBuffer(GL_ARRAY_BUFFER,color_VBO)
        glColorPointer(3,GL_FLOAT,0,None)
        glEnableClientState(GL_COLOR_ARRAY)
        #è§£ç»‘
        glBindVertexArray(0)
        draw=True
    glBindVertexArray(block_VAO)
    glDrawElements(GL_QUADS,block_EBO_buffer_len,GL_UNSIGNED_INT,None)
    glBindVertexArray(0)
def print_text_list(text:list,callback=None,x=0,y=0,m=1,color=(250,255,255)):#TODO:ä»¥ååˆ«å¿˜äº†æŠŠè¿™ä¸ªé¢œè‰²æ”¹æ‰ï¼Œæ¢ä¸ªæ›´å¥½çœ‹çš„
    global font,window_width
    debug_hDC=wglGetCurrentDC()
    font_hieght=30
    #è®¾å®šæ–‡å­—çš„å­—ä½“ã€é¢œè‰²å’ŒèƒŒæ™¯
    win32gui.SelectObject(debug_hDC,win32ui.CreateFont({"height":font_hieght,"name":font}).GetSafeHandle())
    win32gui.SetBkMode(debug_hDC,win32con.TRANSPARENT)
    glColor3ub(color[0],color[1],color[2])
    if callback is not None:callback(debug_hDC)
    #å¼€å§‹æ˜¾ç¤ºï¼ˆæŠŠè¿æ¥å’Œæ˜¾ç¤ºæ•´åˆ°ä¸€èµ·å»äº†ï¼‰
    glLoadIdentity()
    glTranslatef(-0.3,0.29,-0.1)#-0.1æ˜¯ä¸ºäº†é˜²æ­¢æ–‡å­—è¢«åé¢çš„ç‰©ä½“é®æŒ¡ï¼
    qaq=y
    draw_text_list=glGenLists(1)
    for i in text:
        glRasterPos2f(x,-qaq)
        for ii in i:
            for iii in str(ii):
                wglUseFontBitmapsW(debug_hDC,ord(iii),1,draw_text_list)
                glCallList(draw_text_list)
        qaq+=font_hieght/3000*m
    win32gui.DeleteObject(debug_hDC)
def debug_print_coordinates_text(hDC):
    #æ˜¾ç¤ºåæ ‡ç³»æ–‡å­—ï¼ˆæ–¹ä¾¿ä¸MCåŸç‰ˆè¿›è¡ŒçŸ«æ­£ï¼‰
    a=glGenLists(1)
    glRasterPos3f(1,0,0)
    wglUseFontBitmapsW(hDC,ord('x'),1,a)
    glCallList(a)
    glRasterPos3f(0,1,0)
    wglUseFontBitmapsW(hDC,ord('y'),1,a)
    glCallList(a)
    glRasterPos3f(0,0,1)
    wglUseFontBitmapsW(hDC,ord('z'),1,a)
    glCallList(a)
def debug_main():
    global debug,player_see_x,player_see_y,player_x,player_y,player_z,debug_text
    if debug:
        #æ˜¾ç¤ºä¸€ä¸ªä¸–ç•ŒåŸç‚¹çš„åæ ‡ç³»
        glBegin(GL_LINES)
        glColor3ub(0,0,255)
        glVertex3f(0,0,0)
        glVertex3f(1,0,0)
        glColor3ub(0,255,0)
        glVertex3f(0,0,0)
        glVertex3f(0,1,0)
        glColor3ub(255,0,0)
        glVertex3f(0,0,0)
        glVertex3f(0,0,1)
        glEnd()
        a=debug_text[0]
        a[1]=round(player_x,2)
        a[3]=round(player_y,2)
        a[5]=round(player_z,2)
        debug_text[0]=a
        a=debug_text[1]
        a[1]=round(player_see_x,2)
        a[3]=round(player_see_y,2)
        debug_text[1]=a
        #è°ƒç”¨æ–‡å­—æ˜¾ç¤ºå‡½æ•°æ˜¾ç¤ºdebugå†…å®¹ï¼Œå¹¶é¡ºä¾¿æ‰“å°æ–‡å­—å‡ºæ¥
        print_text_list(debug_text,debug_print_coordinates_text)
def view_orientations(px,py,callback=None):
    #æˆ‘è¿˜æ²¡æœ‰å­¦è¿‡ä¸‰è§’å‡½æ•°ï¼Œå› æ­¤å¦‚æœè¾“å…¥è´Ÿæ•°ä¹Ÿèƒ½æ­£å¸¸ä½¿ç”¨ï¼Œä»¥ä¸‹ä»£ç å¯ä»¥æ›´åŠ ç®€æ´ã€‚è¯·å¸®å¿™æ”¹ä¸€æ”¹å“ˆğŸ˜€
    if callback is not None:
        px,py=callback(px,py)
    if px>=0:
        if px>90:
            x=math.cos(px-90)
            z=math.sin(px-90)*-1
        else:
            x=math.sin(px)
            z=math.cos(px)
    else:
        if px<-90:
            x=math.cos((px+90)*-1)*-1
            z=math.sin((px+90)*-1)*-1
        else:
            x=math.sin(px*-1)*-1
            z=math.cos(px*-1)
    if py>=0:
        y=math.sin(py)
    else:
        y=math.sin(py*-1)*-1
    return x,y,z
def world_main_loop():
    global input_text,chat_list_show_time
    glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT)
    glMatrixMode(GL_PROJECTION)
    glLoadIdentity()
    glFrustum(-0.3,0.3,-0.3,0.3,0.1,8)
    #ç¬”è®°ï¼š
    #glFrustum(left,right,bottom,top,zNear,zFar)
    #è¿™ä¸ªå‡½æ•°çš„å‚æ•°åªå®šä¹‰è¿‘è£å‰ªå¹³é¢çš„å·¦ä¸‹è§’ç‚¹å’Œå³ä¸Šè§’ç‚¹çš„ä¸‰ç»´ç©ºé—´åæ ‡ï¼Œå³ï¼ˆleftï¼Œbottomï¼Œ-nearï¼‰å’Œï¼ˆrightï¼Œtopï¼Œ-near)
    glMatrixMode(GL_MODELVIEW)
    glLoadIdentity()
    #è®¡ç®—è§†è§’æœ›å‘çš„ä½ç½®
    x,y,z=view_orientations(player_see_x,player_see_y)
    gluLookAt(
        player_x,player_y+1,player_z,
        player_x+x,player_y+y+1,player_z+z,
        0,1,0
    )
    #æ¸²æŸ“æ–¹å—
    print_blocks(int(player_x),int(player_y),int(player_z))
    #è°ƒè¯•æ¨¡å¼
    debug_main()
    if chat_list_show_time!=0 and not input_text:
        chat_list_show_time-=1
        if set_chat_list_show_time/3*1<chat_list_show_time:print_text_list([input_buffer]+chat_list,y=0.585,m=-1)
        else:
            a=int(255/(set_chat_list_show_time/3*1)*(set_chat_list_show_time/3*1-(set_chat_list_show_time/3*1)+chat_list_show_time))
            print_text_list([input_buffer]+chat_list,y=0.585,m=-1,color=(a,a,a))
    #æ˜¾ç¤ºæŒ‡ä»¤æ 
    if input_text:print_text_list([input_buffer]+chat_list,y=0.585,m=-1)
    glutSwapBuffers()
def walk_left(a,b):return a+1.57,b#1.57æ˜¯å®æµ‹å‡ºæ¥çš„æ•°æ®~
def spectator_mode(button):
    global player_x,player_y,player_z
    if button in [b'w',b's']:
        x,y,z=view_orientations(player_see_x,player_see_y)
        if button==b's':
            x*=-1
            y*=-1
            z*=-1
    else:
        x,y,z=view_orientations(player_see_x,player_see_y,walk_left)
        if button==b'd':
            x*=-1
            z*=-1
        y=0
    player_x+=x*player_move_speed
    player_y+=y*player_move_speed
    player_z+=z*player_move_speed
    glutPostRedisplay()
def run_command(command):#åä¹‰ä¸Šå«åšè¿è¡ŒæŒ‡ä»¤ï¼Œå®é™…ä¸Šè´Ÿè´£äº†èŠå¤©æ¡†è¾“å…¥äº‹ä»¶å¤„ç†çš„å…¨éƒ¨
    global chat_list,chat_list_show_time,draw
    if command[0]=="/":
        #å¯¹è¾“å…¥è¿›è¡Œæ‹†åˆ†
        command_split=command[1:].split(' ')
        if command_split[0]=="fill":
            for i in range(10):
                write_block(int(command_split[1])+i,int(command_split[2]),int(command_split[3]),int(command_split[4]))
            draw=False
        if command_split[0]=="tp":
            global player_x,player_y,player_z
            player_x=float(command_split[1])
            player_y=float(command_split[2])
            player_z=float(command_split[3])
    chat_list=[input_buffer]+chat_list
    chat_list_show_time=set_chat_list_show_time
def lock_or_unlock_mouse(a):
    global lock_muose
    if a:
        lock_muose=False
        glutSetCursor(GLUT_CURSOR_LEFT_ARROW)
    else:
        glutWarpPointer(window_long,window_width)
        lock_muose=True
        glutSetCursor(GLUT_CURSOR_NONE)
        glutPostRedisplay()
def keyboarddown(button,x,y):
    global keyboard,input_text,input_buffer,debug,lock_muose
    if input_text:
        if button==b'\x1b' or button==b'\r':
            input_text=False
            run_command(input_buffer)
            input_buffer=""
            lock_or_unlock_mouse(False)
        elif button==b'\x08':input_buffer=input_buffer[:-1]
        else:input_buffer+=button.decode()
        glutPostRedisplay()
    else:
        if not keyboard[b'\x1b'] and button==b'\x1b':lock_or_unlock_mouse(lock_muose)#é”å®šæˆ–éé”å®šçŠ¶æ€
        elif not keyboard[b'`'] and button==b'`':#è°ƒè¯•æ¨¡å¼
            if debug:
                glPolygonMode(GL_FRONT_AND_BACK,GL_FILL)
                debug=False
            else:
                glPolygonMode(GL_FRONT_AND_BACK,GL_LINE)
                debug=True
            glutPostRedisplay()
        elif button==b'/':
            input_text=True
            lock_or_unlock_mouse(True)
            input_buffer="/"
            glutPostRedisplay()
            return 0
        elif button==b't':
            input_text=True
            lock_or_unlock_mouse(True)
            glutSetCursor(GLUT_CURSOR_LEFT_ARROW)
            return 0
        keyboard[button]=True
def keyboardup(button,x,y):
    global keyboard
    keyboard[button]=False
def world_mousemove(x,y):
    global player_see_x,player_see_y
    if lock_muose and window_long!=x and window_width!=y:
        player_see_x=(window_long-x)*mouse_move_speed+player_see_x
        player_see_y=(window_width-y)*mouse_move_speed+player_see_y
        #è¿™é‡Œå¢åŠ äº†æ•°å€¼é™åˆ¶ï¼Œé˜²æ­¢è¿‡å¤´ï¼Œå› ä¸ºæ˜¯å®æµ‹çš„æ•°æ®ï¼Œå¯èƒ½æœ‰ä¸å‡†ï¼Œè§è°…~
        if player_see_y>2:player_see_y=2
        if player_see_y<-2:player_see_y=-2
        if player_see_x>3:player_see_x-=6
        if player_see_x<-3: player_see_x+=6
        glutWarpPointer(window_long,window_width)
        glutPostRedisplay()
def backgroud():
    global keyboard
    #é”®ç›˜
    for i in [b'w',b's',b'a',b'd']:
        if keyboard[i]:spectator_mode(i)
    #èŠå¤©æ¡†æ·¡åŒ–äº‹ä»¶ï¼Œå¿…é¡»è¦æ¿€æ´»
    if chat_list_show_time!=0 and not input_text:glutPostRedisplay()
def guide_button_event_init():
    global guide_buttons
    guide_buttons=[]
def guide_main_loop():
    glClear(GL_COLOR_BUFFER_BIT|GL_DEPTH_BUFFER_BIT)
    glColor3f(1.0,0.0,0.0)
    glRectf(-0.5,-0.5,0.5,0.5)
    glutSwapBuffers()
def guide_init():#å¤„ç†æƒ…å†µï¼šæ¸¸æˆé€€å‡ºåˆ°ä¸»ç•Œé¢ï¼Œå…¶ä»–ç•Œé¢é€€å‡ºåˆ°ä¸»ç•Œé¢
    glutSetCursor(GLUT_CURSOR_LEFT_ARROW)
    glutIdleFunc(nothing)
    glutPassiveMotionFunc(nothing)
    glMatrixMode(GL_MODELVIEW)
    glLoadMatrixd(init_info[0])
    glMatrixMode(GL_PROJECTION)
    glLoadMatrixd(init_info[1])
    glutDisplayFunc(guide_main_loop)
def go_to_world():
    glutSetCursor(GLUT_CURSOR_NONE)
    glutDisplayFunc(world_main_loop)
    glutIdleFunc(backgroud)
    glutPassiveMotionFunc(world_mousemove)
def nothing(*args):pass
def init():
    #è¿›è¡Œglutçš„æœ€åŸºç¡€åˆå§‹åŒ–
    glutInit()
    glutInitDisplayMode(GLUT_DOUBLE|GLUT_DEPTH)
    glutCreateWindow("PyMinecraft ByWzq".encode('GBK',errors="replace"))
    #ä½¿ç”¨æˆ·æ— æ³•æ›´æ”¹çª—å£å¤§å°
    hwnd=win32gui.GetForegroundWindow()
    A=win32gui.GetWindowLong(hwnd,win32con.GWL_STYLE)
    A^=win32con.WS_THICKFRAME
    win32gui.SetWindowLong(hwnd,win32con.GWL_STYLE,A)
    #å®Œæˆå…¶ä½™çš„åˆå§‹åŒ–
    glutReshapeWindow(window_long*2,window_width*2)
    glViewport(0,0,window_long*2,window_width*2)
    glClearColor(0.0,0.0,0.0,0.0)
init()
glEnable(GL_DEPTH_TEST)
glDepthFunc(GL_LESS)
glutKeyboardFunc(keyboarddown)
glutKeyboardUpFunc(keyboardup)
init_info=(glGetDoublev(GL_MODELVIEW_MATRIX),glGetDoublev(GL_PROJECTION_MATRIX))
go_to_world()
glutMainLoop()#æ­£å¼å¼€å§‹è¿è¡Œ
